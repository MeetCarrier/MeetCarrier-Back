<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h1>WebSocket í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>

<button onclick="loginAsTestUser()">ğŸ§ª í…ŒìŠ¤íŠ¸ ìœ ì €ë¡œ ë¡œê·¸ì¸</button>
<p id="loginStatus" style="color: green;"></p>
<button onclick="loginAsTestUser2()">ğŸ§ª í…ŒìŠ¤íŠ¸ ìœ ì €2ë¡œ ë¡œê·¸ì¸</button>

<hr>

<div>
    <label>URL: </label>
    <input type="text" id="connectUrl" placeholder="ì˜ˆ: /ws" value="/ws">
    <label><input type="checkbox" id="sockJsEnabled"> SockJS</label>
    <label><input type="checkbox" id="stompEnabled" checked> STOMP</label>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
</div>

<hr>

<div>
    <label>STOMP subscribe destination:</label>
    <input type="text" id="subscribePath" placeholder="/topic/assistant/1">
    <button onclick="subscribe()">Subscribe</button>
</div>

<div>
    <label>STOMP send destination:</label>
    <input type="text" id="sendPath" placeholder="/app/api/assistant/send" value="/app/api/assistant/send">
</div>

<div>
    <div>
        <label>Message Content (JSON):</label><br>
        <textarea id="messageContent" rows="5" cols="80" placeholder='ì˜ˆ: {"roomId":1000,"userId":10,"type":"TEXT","message":"ì§ˆë¬¸"}'></textarea>
        <br>
        <button onclick="sendMessage()">Send</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
</div>

<div>
    <h3>ìˆ˜ì‹  ë©”ì‹œì§€:</h3>
    <pre id="messageOutput"></pre>
</div>

<script type="text/javascript">
    let stompClient = null;

    function loginAsTestUser() {
        fetch('/api/auth/test/login', {
            method: 'POST',
            credentials: 'include' // JSESSIONID ì¿ í‚¤ ì €ì¥
        })
            .then(res => {
                if (res.ok) {
                    document.getElementById('loginStatus').textContent = 'âœ… í…ŒìŠ¤íŠ¸ ìœ ì €ë¡œ ë¡œê·¸ì¸ ì„±ê³µ';
                } else {
                    document.getElementById('loginStatus').textContent = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨';
                }
            })
            .catch(error => {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                document.getElementById('loginStatus').textContent = 'âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜ ë°œìƒ';
            });
    }

    function loginAsTestUser2() {
        fetch('/api/auth/test/login2', {
            method: 'POST',
            credentials: 'include' // JSESSIONID ì¿ í‚¤ ì €ì¥
        })
            .then(res => {
                if (res.ok) {
                    document.getElementById('loginStatus').textContent = 'âœ… í…ŒìŠ¤íŠ¸ ìœ ì €2ë¡œ ë¡œê·¸ì¸ ì„±ê³µ';
                } else {
                    document.getElementById('loginStatus').textContent = 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨';
                }
            })
            .catch(error => {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                document.getElementById('loginStatus').textContent = 'âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜ ë°œìƒ';
            });
    }

    function connect() {
        const url = document.getElementById('connectUrl').value;
        const useSockJs = document.getElementById('sockJsEnabled').checked;
        const useStomp = document.getElementById('stompEnabled').checked;

        let socket = useSockJs ? new SockJS(url) : new WebSocket(url);

        if (useStomp) {
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log("STOMP Connected: " + frame);
                appendOutput("âœ… STOMP ì—°ê²°ë¨");
            }, function (error) {
                console.error("STOMP ì—°ê²° ì‹¤íŒ¨", error);
                appendOutput("âŒ STOMP ì—°ê²° ì‹¤íŒ¨: " + error);
            });
        } else {
            socket.onopen = () => appendOutput("âœ… WebSocket ì—°ê²°ë¨");
            socket.onmessage = (event) => appendOutput("ğŸ“© ìˆ˜ì‹ : " + event.data);
            socket.onerror = (err) => appendOutput("âŒ ì˜¤ë¥˜: " + err.message);
        }
    }

    function disconnect() {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(() => {
                appendOutput("ğŸ›‘ ì—°ê²° í•´ì œë¨");
            });
        } else {
            appendOutput("â„¹ï¸ ì—°ê²°ëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤");
        }
    }


    function subscribe() {
        const path = document.getElementById('subscribePath').value;
        if (stompClient && stompClient.connected) {
            stompClient.subscribe(path, function (message) {
                const body = message.body;
                appendOutput("ğŸ“© êµ¬ë… ìˆ˜ì‹ : " + body);
            });
            appendOutput("ğŸ“¡ êµ¬ë… ì‹œì‘: " + path);
        } else {
            alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.");
        }
    }

    function sendMessage() {
        const path = document.getElementById('sendPath').value;
        const rawContent = document.getElementById('messageContent').value;

        try {
            const json = JSON.parse(rawContent);  // ë¬¸ìì—´ì„ JSONìœ¼ë¡œ ë³€í™˜

            if (stompClient && stompClient.connected) {
                stompClient.send(path, {}, JSON.stringify(json));
                appendOutput("ğŸ“¤ ì „ì†¡: " + rawContent);
            } else {
                alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.");
            }
        } catch (e) {
            alert("ìœ íš¨í•œ JSONì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
    }

    function clearOutput() {
        document.getElementById('messageOutput').textContent = '';
    }

    function appendOutput(message) {
        const output = document.getElementById('messageOutput');
        output.textContent += message + '\n';
    }
</script>
</body>
</html>
