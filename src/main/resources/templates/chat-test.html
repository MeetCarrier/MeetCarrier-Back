<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ… êµ¬ë… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        .container { display: flex; gap: 20px; }
        .panel { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
        h1, h2, h3 { color: #333; }
        button { padding: 8px 12px; margin: 5px 2px; border: 1px solid #666; border-radius: 4px; cursor: pointer; background-color: #f0f0f0; }
        button:hover { background-color: #e0e0e0; }
        button.primary { background-color: #007bff; color: white; border-color: #007bff; }
        button.primary:hover { background-color: #0056b3; }
        input[type="text"], textarea { width: 95%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        pre { background-color: #eee; border: 1px solid #ddd; padding: 10px; white-space: pre-wrap; word-wrap: break-word; min-height: 80px; }
        .status { font-weight: bold; }
        .status.connected { color: green; }
        .status.disconnected { color: red; }
        .output-label { font-weight: bold; margin-top: 15px; display: block; }
    </style>
</head>
<body>

<h1>ì±„íŒ… êµ¬ë… ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸</h1>
<p><b>ì‚¬ìš©ë²•:</b> ì´ í˜ì´ì§€ë¥¼ ë‘ ê°œì˜ ë¸Œë¼ìš°ì € ì°½ì— ì—´ê³ , ê°ê° ë‹¤ë¥¸ ìœ ì €ë¡œ ë¡œê·¸ì¸í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ì„¸ìš”.</p>

<div class="container">
    <div class="panel">
        <h2>ğŸ§‘ğŸ»â€ğŸ’» ì‚¬ìš©ì 1 (ID: 1000)</h2>
        <p><b>Room ID:</b> 1008</p>
        <div>
            <button onclick="login(1)">1. ë¡œê·¸ì¸</button>
            <button class="primary" onclick="connect(1)">2. WebSocket ì—°ê²°</button>
            <button onclick="disconnect(1)">ì—°ê²° í•´ì œ</button>
            <p id="status-1" class="status disconnected">ì—°ê²° ìƒíƒœ: ëŠê¹€</p>
        </div>
        <hr>
        <div>
            <h3>êµ¬ë… ê´€ë¦¬</h3>
            <button onclick="subscribeUserTopic(1)">ì±„íŒ… ëª©ë¡ êµ¬ë…</button>
            <button onclick="subscribeRoomTopic(1)">ì±„íŒ…ë°© êµ¬ë…</button>
            <button onclick="unsubscribeRoomTopic(1)">ì±„íŒ…ë°© êµ¬ë… í•´ì œ</button>
        </div>
        <hr>
        <div>
            <h3>ì•¡ì…˜</h3>
            <button onclick="markAsRead(1)">'ì½ìŒ' ì²˜ë¦¬ API ì§ì ‘ í˜¸ì¶œ</button>
            <textarea id="message-1" rows="4">{"type": "TEXT", "message": "ì•ˆë…•í•˜ì„¸ìš”! User 1 ì…ë‹ˆë‹¤."}</textarea>
            <button class="primary" onclick="sendMessage(1)">ë©”ì‹œì§€ ì „ì†¡</button>
        </div>
        <hr>
        <div>
            <label class="output-label">ì±„íŒ… ëª©ë¡ ì—…ë°ì´íŠ¸ (/topic/user/1000/chats):</label>
            <pre id="list-output-1"></pre>
            <label class="output-label">ì±„íŒ…ë°© ë©”ì‹œì§€ (/topic/room/1008):</label>
            <pre id="room-output-1"></pre>
            <label class="output-label">ì½ìŒ í™•ì¸ ì•Œë¦¼ (/topic/room/1008/read):</label>
            <pre id="read-output-1"></pre>
        </div>
    </div>

    <div class="panel">
        <h2>ğŸ§‘ğŸ¼â€ğŸ’» ì‚¬ìš©ì 2 (ID: 1001)</h2>
        <p><b>Room ID:</b> 1008</p>
        <div>
            <button onclick="login(2)">1. ë¡œê·¸ì¸</button>
            <button class="primary" onclick="connect(2)">2. WebSocket ì—°ê²°</button>
            <button onclick="disconnect(2)">ì—°ê²° í•´ì œ</button>
            <p id="status-2" class="status disconnected">ì—°ê²° ìƒíƒœ: ëŠê¹€</p>
        </div>
        <hr>
        <div>
            <h3>êµ¬ë… ê´€ë¦¬</h3>
            <button onclick="subscribeUserTopic(2)">ì±„íŒ… ëª©ë¡ êµ¬ë…</button>
            <button onclick="subscribeRoomTopic(2)">ì±„íŒ…ë°© êµ¬ë…</button>
            <button onclick="unsubscribeRoomTopic(2)">ì±„íŒ…ë°© êµ¬ë… í•´ì œ</button>
        </div>
        <hr>
        <div>
            <h3>ì•¡ì…˜</h3>
            <button onclick="markAsRead(2)">'ì½ìŒ' ì²˜ë¦¬ API ì§ì ‘ í˜¸ì¶œ</button>
            <textarea id="message-2" rows="4">{"type": "TEXT", "message": "ë°˜ê°‘ìŠµë‹ˆë‹¤! User 2 ì…ë‹ˆë‹¤."}</textarea>
            <button class="primary" onclick="sendMessage(2)">ë©”ì‹œì§€ ì „ì†¡</button>
        </div>
        <hr>
        <div>
            <label class="output-label">ì±„íŒ… ëª©ë¡ ì—…ë°ì´íŠ¸ (/topic/user/1001/chats):</label>
            <pre id="list-output-2"></pre>
            <label class="output-label">ì±„íŒ…ë°© ë©”ì‹œì§€ (/topic/room/1008):</label>
            <pre id="room-output-2"></pre>
            <label class="output-label">ì½ìŒ í™•ì¸ ì•Œë¦¼ (/topic/room/1008/read):</label>
            <pre id="read-output-2"></pre>
        </div>
    </div>
</div>

<script type="text/javascript">
    const stompClients = {};
    const subscriptions = {};

    const USER_IDS = { 1: 1000, 2: 1001 };
    const ROOM_ID = 1008;

    function getLoginUrl(userNum) {
        return userNum === 1 ? '/api/auth/test/login' : '/api/auth/test/login2';
    }

    function login(userNum) {
        fetch(getLoginUrl(userNum), {
            method: 'POST',
            credentials: 'include'
        }).then(res => {
            document.getElementById(`status-${userNum}`).textContent = res.ok ? `âœ… ì‚¬ìš©ì ${userNum} ë¡œê·¸ì¸ ì„±ê³µ` : 'âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨';
        }).catch(err => {
            console.error(`Login error for user ${userNum}:`, err);
            document.getElementById(`status-${userNum}`).textContent = 'âŒ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
        });
    }

    function connect(userNum) {
        if (stompClients[userNum] && stompClients[userNum].connected) {
            alert(`ì‚¬ìš©ì ${userNum}ëŠ” ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
            return;
        }
        const socket = new SockJS('/api/connection');
        const stompClient = Stomp.over(socket);
        stompClient.connect({}, (frame) => {
            console.log(`User ${userNum} Connected: ${frame}`);
            const statusEl = document.getElementById(`status-${userNum}`);
            statusEl.textContent = 'ì—°ê²° ìƒíƒœ: ì—°ê²°ë¨';
            statusEl.className = 'status connected';
            stompClients[userNum] = stompClient;
        }, (error) => {
            console.error(`STOMP connection error for user ${userNum}:`, error);
            document.getElementById(`status-${userNum}`).textContent = `ì—°ê²° ìƒíƒœ: ì‹¤íŒ¨ - ${error}`;
        });
    }

    function disconnect(userNum) {
        if (stompClients[userNum] && stompClients[userNum].connected) {
            stompClients[userNum].disconnect(() => {
                const statusEl = document.getElementById(`status-${userNum}`);
                statusEl.textContent = 'ì—°ê²° ìƒíƒœ: ëŠê¹€';
                statusEl.className = 'status disconnected';
                console.log(`User ${userNum} disconnected.`);
            });
        } else {
            alert(`ì‚¬ìš©ì ${userNum}ëŠ” ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.`);
        }
    }

    function subscribeUserTopic(userNum) {
        const userId = USER_IDS[userNum];
        const path = `/topic/user/${userId}/chats`;
        const client = stompClients[userNum];
        if (client && client.connected) {
            const sub = client.subscribe(path, (message) => appendOutput(userNum, 'list', `[ì±„íŒ…ëª©ë¡] ${message.body}`));
            subscriptions[`user-topic-${userNum}`] = sub;
            appendOutput(userNum, 'list', `Subscribed to ${path}`);
        } else {
            alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');
        }
    }

    function subscribeRoomTopic(userNum) {
        const roomPath = `/topic/room/${ROOM_ID}`;
        const readPath = `/topic/room/${ROOM_ID}/read`; // âœ¨ ì½ìŒ í™•ì¸ í† í”½ ê²½ë¡œ
        const client = stompClients[userNum];

        if (client && client.connected) {
            // ì±„íŒ…ë°© ë©”ì‹œì§€ êµ¬ë…
            const roomSub = client.subscribe(roomPath, (message) => {
                appendOutput(userNum, 'room', `[ì±„íŒ…ë°©] ${message.body}`);
            });
            appendOutput(userNum, 'room', `Subscribed to ${roomPath}`);

            // âœ¨ ì½ìŒ í™•ì¸ ì•Œë¦¼ êµ¬ë…
            const readSub = client.subscribe(readPath, (message) => {
                const readerId = message.body;
                appendOutput(userNum, 'read', `[ì•Œë¦¼] ì‚¬ìš©ì ${readerId} ë‹˜ì´ ë©”ì‹œì§€ë¥¼ ì½ì—ˆìŠµë‹ˆë‹¤.`);
            });
            appendOutput(userNum, 'read', `Subscribed to ${readPath}`);

            // âœ¨ ë‘ ê°œì˜ êµ¬ë…ì„ ë°°ì—´ë¡œ ë¬¶ì–´ì„œ ì €ì¥
            subscriptions[`room-topic-${userNum}`] = [roomSub, readSub];
        } else {
            alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');
        }
    }

    function unsubscribeRoomTopic(userNum) {
        // âœ¨ ë°°ì—´ë¡œ ì €ì¥ëœ êµ¬ë… ì •ë³´ë¥¼ ê°€ì ¸ì˜´
        const subArray = subscriptions[`room-topic-${userNum}`];
        if (subArray && Array.isArray(subArray)) {
            // âœ¨ ë°°ì—´ì˜ ëª¨ë“  êµ¬ë…ì„ í•´ì œ
            subArray.forEach(sub => sub.unsubscribe());
            appendOutput(userNum, 'room', 'ì±„íŒ…ë°© ë° ì½ìŒ í™•ì¸ êµ¬ë…ì„ ëª¨ë‘ í•´ì œí–ˆìŠµë‹ˆë‹¤.');
            appendOutput(userNum, 'read', ''); // ì½ìŒ í™•ì¸ ì°½ë„ ì •ë¦¬
            delete subscriptions[`room-topic-${userNum}`];
        } else {
            alert('êµ¬ë… ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.');
        }
    }

    function markAsRead(userNum) {
        fetch(`/api/chat/${ROOM_ID}/read`, {
            method: 'POST',
            credentials: 'include'
        }).then(res => {
            appendOutput(userNum, 'read', `ì½ìŒ ì²˜ë¦¬ API í˜¸ì¶œ: ${res.ok ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}`);
        }).catch(err => console.error(`Mark as read error for user ${userNum}:`, err));
    }

    function sendMessage(userNum) {
        const sendPath = '/app/api/chat/send';
        const client = stompClients[userNum];
        const messageContentEl = document.getElementById(`message-${userNum}`);
        if (client && client.connected) {
            try {
                const customContent = JSON.parse(messageContentEl.value);
                const payload = { roomId: ROOM_ID, ...customContent };
                client.send(sendPath, {}, JSON.stringify(payload));
                appendOutput(userNum, 'room', `[ì „ì†¡] ${JSON.stringify(payload)}`);
            } catch (e) {
                alert('ìœ íš¨í•œ JSON í˜•ì‹ì˜ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            }
        } else {
            alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.');
        }
    }

    function appendOutput(userNum, type, message) {
        const outputEl = document.getElementById(`${type}-output-${userNum}`);
        outputEl.textContent += `\n${new Date().toLocaleTimeString()} > ${message}`;
        outputEl.scrollTop = outputEl.scrollHeight;
    }
</script>

</body>
</html>