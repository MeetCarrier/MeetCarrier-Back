<!-- src/main/resources/templates/fcm-test.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>FCM ํธ์ ํ์คํธ</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
</head>
<body>
<h2>โ FCM ํธ์ ํ์คํธ ํ์ด์ง</h2>

<button onclick="loginAsTestUser()">๐งช ํ์คํธ ์์๋ก ๋ก๊ทธ์ธ</button>
<button onclick="loginAsTestUser2()">๐งช ํ์คํธ ์์2๋ก ๋ก๊ทธ์ธ</button>
<p id="loginStatus" style="color: green;"></p>
<br><br>

<button id="getTokenBtn">FCM ํํฐ ๋ฐ๊ธ ๋ฐ ์๋ฒ ์์ก</button>
<br><br>
<button id="sendTestPushBtn">ํ์คํธ ํธ์ ์๋ฆผ ๋ณด๋ด๊ธฐ</button>

<script>
  function loginAsTestUser() {
    fetch('/api/auth/test/login', {
      method: 'POST',
      credentials: 'include' // JSESSIONID ์ฟํค ์์ฅ
    })
            .then(res => {
              if (res.ok) {
                document.getElementById('loginStatus').textContent = 'โ ํ์คํธ ์์๋ก ๋ก๊ทธ์ธ ์ฑ๊ณต';
              } else {
                document.getElementById('loginStatus').textContent = 'โ ๋ก๊ทธ์ธ ์คํจ';
              }
            })
            .catch(error => {
              console.error('๋ก๊ทธ์ธ ์ค๋ฅ:', error);
              document.getElementById('loginStatus').textContent = 'โ ๋ก๊ทธ์ธ ์ค๋ฅ ๋ฐ์';
            });
  }

  function loginAsTestUser2() {
    fetch('/api/auth/test/login2', {
      method: 'POST',
      credentials: 'include' // JSESSIONID ์ฟํค ์์ฅ
    })
            .then(res => {
              if (res.ok) {
                document.getElementById('loginStatus').textContent = 'โ ํ์คํธ ์์2๋ก ๋ก๊ทธ์ธ ์ฑ๊ณต';
              } else {
                document.getElementById('loginStatus').textContent = 'โ ๋ก๊ทธ์ธ ์คํจ';
              }
            })
            .catch(error => {
              console.error('๋ก๊ทธ์ธ ์ค๋ฅ:', error);
              document.getElementById('loginStatus').textContent = 'โ ๋ก๊ทธ์ธ ์ค๋ฅ ๋ฐ์';
            });
  }

  const firebaseConfig = {
    apiKey: "AIzaSyDDKskTEH8iAfPKeXJ2E0hgYr40ORmoo7I",
    authDomain: "mannam-d4e57.firebaseapp.com",
    projectId: "mannam-d4e57",
    storageBucket: "mannam-d4e57.firebasestorage.app",
    messagingSenderId: "818635958228",
    appId: "1:818635958228:web:b6ad2e0b61f1a9c3b49841",
  };

  firebase.initializeApp(firebaseConfig);
  const messaging = firebase.messaging();

  // โ๏ธ serviceWorker.register()์ .then() ์์์ ๋ชจ๋ ๋ก์ง์ ์ฒ๋ฆฌํฉ๋๋ค.
  navigator.serviceWorker.register('/firebase-messaging-sw.js')
          .then((registration) => { // 'registration' ๊ฐ์ฒด๋ฅผ ๋ฐ์ต๋๋ค.
            console.log("โ Service Worker ๋ฑ๋ก ์๋ฃ:", registration);

            document.getElementById('getTokenBtn').onclick = function () {
              Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                  console.log("์๋ฆผ ๊ถํ์ด ํ์ฉ๋์์ต๋๋ค. ํํฐ์ ๋ฐ๊ธํฉ๋๋ค.");

                  // โ๏ธ[์์] getToken์ ํ์ฌ ๋ฑ๋ก ๊ฐ์ฒด๋ฅผ ๋ช์์์ผ๋ก ์๋ฌํฉ๋๋ค.
                  messaging.getToken({
                    vapidKey: "BL_f_s3clxhm9ZX-jLfgujT2lFGpb1C-jw1qTZIgXtnJjVthGsrXKLDBkxGUgHEfzz4-MFAyv3QRfAfqTZqcBeY",
                    serviceWorkerRegistration: registration // ์ด ๋ถ๋ถ์ด ํต์ฌ์๋๋ค.
                  }).then((token) => {
                    console.log("๐ฑ ํํฐ ๋ฐ๊ธ ์๋ฃ:", token);
                    fetch('/api/fcm/token', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ token })
                    }).then(() => {
                      alert("FCM ํํฐ์ด ์๋ฒ์ ๋ฑ๋ก๋์์ต๋๋ค.");
                    });
                  }).catch(err => {
                    console.error('ํํฐ ๋ฐ๊ธ ์ค ์ค๋ฅ ๋ฐ์:', err);
                  });
                } else {
                  alert("์๋ฆผ ๊ถํ์ด ๊ฑฐ๋ถ๋์์ต๋๋ค.");
                }
              });
            };

            document.getElementById('sendTestPushBtn').onclick = function () {
              alert("5์ด ํ ํ์คํธ ํธ์ ์๋ฆผ์ด ์์ก๋ฉ๋๋ค...");
              setTimeout(() => {
                fetch('/api/fcm/test', {
                  method: 'POST'
                }).then(() => alert("โ ํ์คํธ ํธ์ ์๋ฆผ์ด ์์ก๋์์ต๋๋ค."));
              }, 5000);
            };
          })
          .catch(err => {
            console.error("Service Worker ๋ฑ๋ก ์คํจ:", err);
          });
</script>
</body>
</html>
